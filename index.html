<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title></title>
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<script src="js/jquery.easing.1.3.js"></script>
	<!--[if IE]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<script type="text/javascript" src="js/rhill-voronoi-core.js"></script>
	<script type="text/javascript" src="js/please.js"></script>
	<script id="script" type="text/javascript">
	function pick(list, previous) {
		var result = list[Math.round(Math.random() * (list.length - 1))];
		if (typeof previous != "undefined") {
			while (pick == previous) {
				result = list[Math.round(Math.random() * (list.length - 1))];
			}
		}
		return result;
	}

	var VoronoiAnimation = {
		voronoi: new Voronoi(),
		sites: [],
		diagram: null,
		// margin for placement of random dots
		margin: 125,
		canvas: null,
		colors: [],
		bbox: {xl:0,xr:0,yt:0,yb:0},
		normalizeEventCoords: function(target,e) {
			// http://www.quirksmode.org/js/events_properties.html#position
			if (!e) {e=self.event;}
			var x = 0;
			var y = 0;
			if (e.pageX || e.pageY) {
				x = e.pageX;
				y = e.pageY;
			}
			else if (e.clientX || e.clientY) {
				x = e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;
				y = e.clientY+document.body.scrollTop+document.documentElement.scrollTop;
			}
			return {x:x-target.offsetLeft,y:y-target.offsetTop};
		},
		init: function() {
			var me = this;
			this.canvas = document.getElementById('voronoiCanvas');
			this.overlay = document.getElementById('overlayCanvas');
			// update with size of canvas
			this.bbox.xr = this.canvas.width;
			this.bbox.yb = this.canvas.height;
			// generate colors
			var base = {
				h: Math.random() * 360,
				s: Math.random() * 1.0,
				v: Math.random() * 1.0
			};
			// debug
			console.log('base color (hsv): ', base);
			console.log('base color (hex): ', Please.HSV_to_HEX(base));
			var amount = 27;
			// make color scheme
			this.colors = Please.make_scheme(base, {
					scheme_type: 'cst',
					amount: 5,
					seperation: 25,
					format: 'hex'
			});
			// mouse events
			$(this.canvas).on('mousemove', function(e) {
				if (!me.sites.length) 
					return;
				var site = me.sites[0];
				var mouse = me.normalizeEventCoords(me.canvas,e);
				site.x = mouse.x;
				site.y = mouse.y;
				me.voronoi.recycle(me.diagram);
				me.diagram = me.voronoi.compute(me.sites, me.bbox);
				me.render();
			});
			// generate random diagram
			this.randomSites(amount, true);
			// render it
			this.render();
			// animate sites
			setInterval('VoronoiAnimation.animate()', 1000/30);
			// show byLines
			this.byLineEl = document.getElementById('byline');
			this.prevByLine = byLines[0];
			this.byLineEl.innerHTML = byLines[0];
			setInterval('VoronoiAnimation.ticker()', 5 * 1000);
		},
		ticker: function() {
			var byLine = pick(byLines, this.prevByLine);
			this.prevByLine = byline;
			var el = this.byLineEl;
			$(this.byLineEl).animate({
				opacity: 0
			}, 750, "easeOutQuad", function() {		
				el.innerHTML = byLine;
				$(el).animate({
					opacity: 1
				}, 1000, "easeInQuad");
			});
			
		},
		animate: function() {
			for (var i=1; i<this.sites.length; i++) {
				var site = this.sites[i];
				// detect and flip directions in x
				site.x += site.dx * site.v;
				if (site.x < 0 || site.x > this.canvas.width) {
					site.dx = -site.dx;
				}
				site.x = Math.min(this.canvas.width, Math.max(0, site.x));
				// detect and flip directions in y
				site.y += site.dy * site.v;
				if (site.y < 0 || site.y > this.canvas.height) {
					site.dy = -site.dy;
				}
				site.y = Math.min(this.canvas.height, Math.max(0, site.y));
				// persist changes
				this.sites[i] = site;
			}
			// recompute and render
			this.voronoi.recycle(this.diagram);
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
			this.render();
		},
		clearSites: function() {
			this.sites = [];
			// we want at least one site (tracking the mouse)
			this.addSite(0, 0);
			this.voronoi.recycle(this.diagram);
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
		},
		randomSites: function(n, clear) {
			if (clear)
				this.sites = [];
			var xo = this.margin;
			var dx = this.canvas.width-this.margin*2;
			var yo = this.margin;
			var dy = this.canvas.height-this.margin*2;
			for (var i=0; i < n; i++) {
				// random site within margin distance from canvas border
				this.addSite(Math.round(xo + self.Math.random()*dx), Math.round(yo + self.Math.random()*dy));
			}
			this.voronoi.recycle(this.diagram);
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
		},
		addSite: function(x,y) {
			this.sites.push({
				x: x,
				y: y,
				dx: (Math.random() > 0.5) ? -1 : 1,
				dy: (Math.random() > 0.5) ? -1 : 1,
				v: Math.random(),
				c: this.colors[Math.round(Math.random() * this.colors.length)]
			});
			this.voronoi.recycle(this.diagram);
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
		},
		renderEdges: function(ctx, color) {
			var edges = this.diagram.edges;
			var nEdges = edges.length;
			var v;
			if (nEdges) {
				var edge;
				ctx.beginPath();
				ctx.strokeStyle=color;
				while (nEdges--) {
					edge = edges[nEdges];
					v = edge.va;
					ctx.moveTo(v.x,v.y);
					v = edge.vb;
					ctx.lineTo(v.x,v.y);
				}
				ctx.stroke();
			}
		},
		renderSites: function(ctx, color) {
			var sites = this.sites;
			var nSites = sites.length;
			var site;
			ctx.beginPath();
			ctx.fillStyle = color;
			while (nSites--) {
				site = sites[nSites];
				ctx.rect(site.x-2/3,site.y-2/3,2,2);
			}
			ctx.fill();
		},
		renderCell: function(ctx, cell, color) {
			var halfedges = cell.halfedges;
			var nHalfedges = halfedges.length;
			if (nHalfedges > 2) {
				v = halfedges[0].getStartpoint();
				ctx.beginPath();
				ctx.moveTo(v.x,v.y);
				for (var iHalfedge=0; iHalfedge<nHalfedges; iHalfedge++) {
					v = halfedges[iHalfedge].getEndpoint();
					ctx.lineTo(v.x, v.y);
				}
				ctx.fillStyle = color;
				ctx.fill();
			}
		},
		renderCellOutline: function(ctx, cell, color) {
			var halfedges = cell.halfedges;
			var nHalfedges = halfedges.length;
			if (nHalfedges > 2) {
				v = halfedges[0].getStartpoint();
				ctx.beginPath();
				ctx.moveTo(v.x,v.y);
				for (var iHalfedge=0; iHalfedge<nHalfedges; iHalfedge++) {
					v = halfedges[iHalfedge].getEndpoint();
					ctx.lineTo(v.x, v.y);
				}
				ctx.strokeStyle = color;
				ctx.stroke();
			}
		},
		clear: function(ctx, color, alpha) {
			ctx.globalAlpha = alpha;
			ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
		},
		render: function() {
			var ctx = this.canvas.getContext('2d');
			this.clear(ctx, '#fdd', 1.0);
			var ovr = this.overlay.getContext('2d');
			this.clear(ovr, '#000', 1.0);
			// voronoi 
			// render cells
			for(var i=0; i < this.diagram.cells.length; i++) {
				var cell = this.diagram.cells[i];
				if (cell.site.c == undefined) {
					cell.site.c =  this.colors[Math.round(Math.random() * this.colors.length)];
				}
				this.renderCell(ctx, cell, cell.site.c);
			}
			// highlight cell under mouse
			var cell = this.diagram.cells[this.sites[0].voronoiId];
			// there is no guarantee a Voronoi cell will exist for any particular site
			if (cell) {
//				debugger;
				this.renderCellOutline(ovr, cell, '#000');
				ctx.globalAlpha = 0.5;
				this.renderCell(ovr, cell, '#fff');
			}
			if (document.location.hash == '#debug') {
				document.getElementById('caption').style.display = 'none';
				// edges
				this.renderEdges(ctx, '#f0f');
				// draw sites
				this.renderSites(ctx, '#f0f');
			}
		}
	};

	var byLines = [
		'Can be found on, <a href="https://github.com/brucejillis">Github</a>',
		'Can be found on, <a href="https://www.youtube.com/user/JillisterHove">YouTube</a>',
		'Is sometimes on, <a href="https://twitter.com/jillis">Twitter</a>',
		'Lives in, <a href="https://www.google.nl/maps/place/Arnhem/@52.0056159,5.8965987,12z/data=!3m1!4b1!4m2!3m1!1s0x47c7ba91ce9b2273:0x161c5ae0f973cad7?hl=en">Arnhem, the Netherlands</a>'
	];

	$(document).ready(function() {
			var canvas = document.getElementById('voronoiCanvas');
			var overlay = document.getElementById('overlayCanvas');
			window.addEventListener('resize', resizeCanvas, false);
			function resizeCanvas() {
				// main canvas
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
				// overlay
				overlay.width = window.innerWidth;
				overlay.height = window.innerHeight;
				VoronoiAnimation.init();
				// dont forget to remove the listener again, or the animation goes wild on resize
				window.removeEventListener('resize', resizeCanvas);
			}
			// resize canvi to browser size
			resizeCanvas();
	});
</script>
<link href='http://fonts.googleapis.com/css?family=Josefin+Sans:700' rel='stylesheet' type='text/css'>
<style>
html, body {
	width: 100%; height: 100%; 	
}
body {
	overflow:hidden;
	margin: 0; padding: 0;
}
canvas {
	width: calc(100% - 32px); height: calc(100% - 32px);
	display: block;
	padding: 16px;
}
#overlayCanvas {
	pointer-events: none;
	position: absolute;
	top: 0px;
	left: 0px;
}
#caption {
	width: calc(100% - 32px);
	height: 234px;
	margin: 0 16px;
	background-color: #fff;
	position: absolute;
	top: 13%;
	pointer-events: none;
	font-size: 1.5em;
	line-height: 1.1em;
	font-family: 'Josefin Sans', sans-serif;
}
#caption h1 {
	position: relative;
	top: 20px;
	left: 20px;
	font-size: 2.5em;
}
#caption h2 {
	position: relative;
	top: 2px;
	left: 20px;
	pointer-events: all;
}
</style>
</head>
<body>
	<canvas id="voronoiCanvas"></canvas>
	<div id="caption">
		<h1>Jillis ter Hove</h1>
		<h2 id="byline"></h2>
	</div>
	<canvas id="overlayCanvas"></canvas>
</body>
</html>