<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title></title>
	<link rel="stylesheet" type="text/css" media="screen" href="css/master.css" />
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<!--[if IE]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<script type="text/javascript" src="js/rhill-voronoi-core.js"></script>
	<script id="script" type="text/javascript">
	var VoronoiAnimation = {
		voronoi: new Voronoi(),
		sites: [],
		diagram: null,
		// margin for placement of random dots
		margin: 125,
		canvas: null,
		colors: [
			'#111',
			'#333',
			'#555',
			'#777',
			'#999',
		],
		bbox: {xl:0,xr:0,yt:0,yb:0},
		normalizeEventCoords: function(target,e) {
			// http://www.quirksmode.org/js/events_properties.html#position
			if (!e) {e=self.event;}
			var x = 0;
			var y = 0;
			if (e.pageX || e.pageY) {
				x = e.pageX;
				y = e.pageY;
			}
			else if (e.clientX || e.clientY) {
				x = e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;
				y = e.clientY+document.body.scrollTop+document.documentElement.scrollTop;
			}
			return {x:x-target.offsetLeft,y:y-target.offsetTop};
		},
		init: function() {
			var me = this;
			this.canvas = document.getElementById('voronoiCanvas');
			// update size of canvas
			this.bbox.xr = this.canvas.width;
			this.bbox.yb = this.canvas.height;
			// mouse events
			this.canvas.onmousemove = function(e) {
				if (!me.sites.length) 
					return;
				var site = me.sites[0];
				var mouse = me.normalizeEventCoords(me.canvas,e);
				site.x = mouse.x;
				site.y = mouse.y;
				me.diagram = me.voronoi.compute(me.sites,me.bbox);
				me.render();
			};
			// generate random diagram
			this.randomSites(10 + Math.random() * 25, true);
			// render it
			this.render();
			// animate sites
			setInterval('VoronoiAnimation.animate()', 31);
		},
		animate: function() {
			for (var i=1; i<this.sites.length; i++) {
				var site = this.sites[i];
				// detect and flip directions in x
				site.x += site.dx * site.v;
				if (site.x < 0 || site.x > this.canvas.width) {
					site.dx = -site.dx;
				}
				site.x = Math.min(this.canvas.width, Math.max(0, site.x));
				// detect and flip directions in y
				site.y += site.dy * site.v;
				if (site.y < 0 || site.y > this.canvas.height) {
					site.dy = -site.dy;
				}
				site.y = Math.min(this.canvas.height, Math.max(0, site.y));
				// persist changes
				this.sites[i] = site;
			}
			// recompute and render
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
			this.render();
		},
		clearSites: function() {
			this.sites = [];
			// we want at least one site (tracking the mouse)
			this.addSite(0, 0);
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
		},

		randomSites: function(n, clear) {
			if (clear)
				this.sites = [];
			var xo = this.margin;
			var dx = this.canvas.width-this.margin*2;
			var yo = this.margin;
			var dy = this.canvas.height-this.margin*2;
			for (var i=0; i < n; i++) {
				// random site within margin distance from canvas border
				this.addSite(Math.round(xo + self.Math.random()*dx), Math.round(yo + self.Math.random()*dy));
			}
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
		},

		addSite: function(x,y) {
			this.sites.push({
				x: x,
				y: y,
				dx: (Math.random() > 0.5) ? -1 : 1,
				dy: (Math.random() > 0.5) ? -1 : 1,
				v: Math.random(),
				c: this.colors[Math.round(Math.random() * this.colors.length)]
			});
			this.diagram = this.voronoi.compute(this.sites, this.bbox);
		},
		renderEdges: function(ctx) {
			var edges = this.diagram.edges;
			var nEdges = edges.length;
			var v;
			if (nEdges) {
				var edge;
				ctx.beginPath();
				while (nEdges--) {
					edge = edges[nEdges];
					v = edge.va;
					ctx.moveTo(v.x,v.y);
					v = edge.vb;
					ctx.lineTo(v.x,v.y);
				}
				ctx.stroke();
			}
		},
		renderSites: function(ctx, color) {
			var sites = this.sites;
			var nSites = sites.length;
			var site;
			ctx.beginPath();
			ctx.fillStyle = color;
			while (nSites--) {
				site = sites[nSites];
				ctx.rect(site.x-2/3,site.y-2/3,2,2);
			}
			ctx.fill();
		},
		renderCell: function(ctx, cell, color) {
			var halfedges = cell.halfedges;
			var nHalfedges = halfedges.length;
			if (nHalfedges > 2) {
				v = halfedges[0].getStartpoint();
				ctx.beginPath();
				ctx.moveTo(v.x,v.y);
				for (var iHalfedge=0; iHalfedge<nHalfedges; iHalfedge++) {
					v = halfedges[iHalfedge].getEndpoint();
					ctx.lineTo(v.x, v.y);
				}
				ctx.fillStyle = color;
				ctx.fill();
			}
		},
		render: function() {
			var ctx = this.canvas.getContext('2d');
			// background
			ctx.globalAlpha = 1;
			ctx.beginPath();
			ctx.rect(0,0,this.canvas.width,this.canvas.height);
			ctx.fillStyle = '#fdd';
			ctx.fill();
			// voronoi 
			// render cells
			for(var i=0; i < this.diagram.cells.length; i++) {
				var cell = this.diagram.cells[i];
				if (cell.site.c == undefined) {
					cell.site.c =  this.colors[Math.round(Math.random() * this.colors.length)];
				}
				this.renderCell(ctx, cell, cell.site.c);
			}
			// edges
			this.renderEdges(ctx, '');
			// highlight cell under mouse
			var cell = this.diagram.cells[this.sites[0].voronoiId];
			// there is no guarantee a Voronoi cell will exist for any particular site
			if (cell) {
				this.renderCell(ctx, cell, '#fff');
			}
			// draw sites
//			this.renderSites(ctx, '#fff');
		}
	};

	$(document).ready(function() {
			var canvas = document.getElementById('voronoiCanvas');
			window.addEventListener('resize', resizeCanvas, false);
			function resizeCanvas() {
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
				VoronoiAnimation.init();
				// dont forget to remove the listener again, or the animation goes wild on resize
				window.removeEventListener('resize', resizeCanvas);
			}
			resizeCanvas();
	});
</script>
<style>
html, body {
	width: 100%; height: 100%; margin: 0; padding: 0;
}
canvas {
	width: 100%; height: 100%;
	display:block;
}
</style>
</head>
<body>
	<canvas id="voronoiCanvas" style="cursor:crosshair"></canvas>
</body>
</html>